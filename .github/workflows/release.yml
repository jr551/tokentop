name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  id-token: write

env:
  BUN_VERSION: '1.2'

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # Workaround: draft releases use lazy tag creation (GitHub doesn't
      # materialize the git tag until the release is published). Without a
      # tag, subsequent release-please runs can't find the latest version
      # and regenerate the entire changelog. Create the tag immediately.
      # See: googleapis/release-please#1650, googleapis/release-please#2267
      # TODO: Replace with `force-tag-creation: true` in release-please-config.json
      # once release-please-action bundles release-please v17.2.0+
      - name: Create git tag for draft release
        if: ${{ steps.release.outputs.release_created }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.release.outputs.tag_name }}"
          SHA="${{ steps.release.outputs.sha }}"
          if gh api "repos/${{ github.repository }}/git/ref/tags/${TAG}" --silent 2>/dev/null; then
            echo "Tag ${TAG} already exists, skipping"
          else
            echo "Creating tag ${TAG} at ${SHA}"
            gh api "repos/${{ github.repository }}/git/refs" \
              --method POST \
              -f "ref=refs/tags/${TAG}" \
              -f "sha=${SHA}"
          fi

  build:
    name: Build ${{ matrix.name }}
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            target: bun-darwin-arm64
            name: ttop-darwin-arm64
          - os: ubuntu-latest
            target: bun-linux-x64
            name: ttop-linux-x64
          - os: ubuntu-24.04-arm
            target: bun-linux-arm64
            name: ttop-linux-arm64
          - os: windows-latest
            target: bun-windows-x64
            name: ttop-windows-x64.exe
    steps:
      - uses: actions/checkout@v6

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build binary
        run: bun build ./src/cli.ts --compile --target=${{ matrix.target }} --outfile=${{ matrix.name }}

      - uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.name }}
          path: ${{ matrix.name }}
          if-no-files-found: error

  upload-assets:
    name: Upload Release Assets
    needs: [release-please, build]
    runs-on: ubuntu-latest
    outputs:
      version: ${{ needs.release-please.outputs.version }}
      sha_darwin_arm64: ${{ steps.checksums.outputs.sha_darwin_arm64 }}
      sha_linux_arm64: ${{ steps.checksums.outputs.sha_linux_arm64 }}
      sha_linux_x64: ${{ steps.checksums.outputs.sha_linux_x64 }}
      sha_windows_x64: ${{ steps.checksums.outputs.sha_windows_x64 }}
    steps:
      - uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          for dir in artifacts/*/; do
            name=$(basename "$dir")
            cp "$dir/$name" "release/$name"
          done
          ls -la release/

      - name: Generate checksums
        id: checksums
        working-directory: release
        run: |
          sha256sum * > SHA256SUMS
          cat SHA256SUMS
          echo "sha_darwin_arm64=$(sha256sum ttop-darwin-arm64 | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"
          echo "sha_linux_arm64=$(sha256sum ttop-linux-arm64 | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"
          echo "sha_linux_x64=$(sha256sum ttop-linux-x64 | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"
          echo "sha_windows_x64=$(sha256sum ttop-windows-x64.exe | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"

      - name: Upload assets to draft release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          draft: true
          files: release/*

  publish-npm:
    name: Publish to npm
    needs: [release-please, upload-assets]
    runs-on: ubuntu-latest
    if: "!contains(needs.release-please.outputs.tag_name, '-')"
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 24
          registry-url: 'https://registry.npmjs.org'

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Publish
        run: npm publish --provenance --access public

  update-homebrew:
    name: Update Homebrew Tap
    needs: [release-please, upload-assets]
    runs-on: ubuntu-latest
    if: "!contains(needs.release-please.outputs.tag_name, '-')"
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6
        with:
          repository: tokentopapp/homebrew-tap
          token: ${{ secrets.TAP_GITHUB_TOKEN }}

      - name: Update formula
        env:
          VERSION: ${{ needs.upload-assets.outputs.version }}
          SHA_DARWIN_ARM64: ${{ needs.upload-assets.outputs.sha_darwin_arm64 }}
          SHA_LINUX_ARM64: ${{ needs.upload-assets.outputs.sha_linux_arm64 }}
          SHA_LINUX_X64: ${{ needs.upload-assets.outputs.sha_linux_x64 }}
        run: |
          cat > Formula/tokentop.rb << EOF
          class Tokentop < Formula
            desc "htop for your AI costs - real-time terminal monitoring of LLM token usage"
            homepage "https://github.com/tokentopapp/tokentop"
            license "MIT"
            version "${VERSION}"

            on_macos do
              url "https://github.com/tokentopapp/tokentop/releases/download/v${VERSION}/ttop-darwin-arm64"
              sha256 "${SHA_DARWIN_ARM64}"
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/tokentopapp/tokentop/releases/download/v${VERSION}/ttop-linux-arm64"
                sha256 "${SHA_LINUX_ARM64}"
              else
                url "https://github.com/tokentopapp/tokentop/releases/download/v${VERSION}/ttop-linux-x64"
                sha256 "${SHA_LINUX_X64}"
              end
            end

            def install
              bin.install Dir["ttop-*"].first => "ttop"
            end

            test do
              assert_match "tokentop", shell_output("#{bin}/ttop --version")
            end
          end
          EOF

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/tokentop.rb
          git diff --staged --quiet || git commit -m "tokentop ${VERSION}"
          git push
        env:
          VERSION: ${{ needs.upload-assets.outputs.version }}

  update-scoop:
    name: Update Scoop Bucket
    needs: [release-please, upload-assets]
    runs-on: ubuntu-latest
    if: "!contains(needs.release-please.outputs.tag_name, '-')"
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6
        with:
          repository: tokentopapp/scoop-tokentop
          token: ${{ secrets.TAP_GITHUB_TOKEN }}

      - name: Update manifest
        env:
          VERSION: ${{ needs.upload-assets.outputs.version }}
          SHA_WINDOWS_X64: ${{ needs.upload-assets.outputs.sha_windows_x64 }}
        run: |
          cat > tokentop.json << EOF
          {
            "version": "${VERSION}",
            "description": "htop for your AI costs - real-time terminal monitoring of LLM token usage",
            "homepage": "https://github.com/tokentopapp/tokentop",
            "license": "MIT",
            "architecture": {
              "64bit": {
                "url": "https://github.com/tokentopapp/tokentop/releases/download/v${VERSION}/ttop-windows-x64.exe",
                "hash": "${SHA_WINDOWS_X64}"
              }
            },
            "bin": [["ttop-windows-x64.exe", "ttop"]],
            "checkver": {
              "github": "https://github.com/tokentopapp/tokentop"
            },
            "autoupdate": {
              "architecture": {
                "64bit": {
                  "url": "https://github.com/tokentopapp/tokentop/releases/download/v\$version/ttop-windows-x64.exe"
                }
              }
            }
          }
          EOF

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add tokentop.json
          git diff --staged --quiet || git commit -m "tokentop ${VERSION}"
          git push
        env:
          VERSION: ${{ needs.upload-assets.outputs.version }}

  publish-release:
    name: Publish Release
    needs: [release-please, upload-assets, publish-npm]
    runs-on: ubuntu-latest
    if: always() && needs.upload-assets.result == 'success'
    steps:
      - name: Publish draft release
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh release edit ${{ needs.release-please.outputs.tag_name }} --repo ${{ github.repository }} --draft=false
